name: Pull request

on: pull_request

jobs:
  build:
    name: Pull request
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: Install dependencies
      run: npm install
  
    - task: SonarCloudPrepare@1
      displayName: 'Prepare analysis on SonarCloud'
      inputs:
        SonarCloud: 'SonarCloud'
        organization: 'nhsdigital'
        scannerMode: 'CLI'
        extraProperties: |
          sonar.projectKey=nhsuk-frontend
          sonar.exclusions=$(System.DefaultWorkingDirectory)/dependency-scan-results/**
          sonar.javascript.lcov.reportPaths=coverage/lcov.info
          sonar.coverage.exclusions=**/*.config.js,**/coverage/**
          sonar.dependencyCheck.htmlReportPath=$(System.DefaultWorkingDirectory)/dependency-scan-results/dependency-check-report.html
          sonar.language=js

    - task: SonarCloudAnalyze@1
      displayName: 'Run SonarCloud Code Analysis'

    - task: SonarCloudPublish@1
      displayName: 'Publish Quality Gate Result'
      inputs:
        pollingTimeoutSec: '300'

    - task: sonarcloud-buildbreaker@2
      displayName: "Break the build if the quality gate fails"
      inputs:
        SonarCloud: 'SonarCloud'
        organization: 'nhsdigital'

    - name: Run linting
      run: npm run lint
    
    - name: Run tests
      run: npm test
  
    - name: Run backstop
      run: npm run backstop:ci
